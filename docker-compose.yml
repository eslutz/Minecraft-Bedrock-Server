services:
  bedrock:
    image: itzg/minecraft-bedrock-server:latest
    platform: linux/arm64
    container_name: minecraft-bedrock
    restart: unless-stopped
    network_mode: host
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: "3.5"
          memory: 6G
        reservations:
          cpus: "2"
          memory: 4G
    environment:
      # ============================================
      # CONTAINER & SERVER CONFIGURATION
      # ============================================

      # Container Settings
      EULA: "TRUE"
      TZ: "America/New_York"
      VERSION: "LATEST"
      PACKAGE_BACKUP_KEEP: "2"
      STOP_SERVER_BEFORE_UPGRADE: "true"

      # Security & Access Control
      ALLOW_LIST: "true"
      ALLOW_LIST_USERS: ${ALLOW_LIST_USERS}
      OPS: ${OPS}
      ONLINE_MODE: "true"

      # Network
      ENABLE_LAN_VISIBILITY: "true"

      # Performance
      VIEW_DISTANCE: "6"
      TICK_DISTANCE: "4"
      MAX_PLAYERS: "6"
      MAX_THREADS: "4"

      # Logging & Observability
      CONTENT_LOG_FILE_ENABLED: "false"
      CONTENT_LOG_LEVEL: "warning"
      CONTENT_LOG_CONSOLE_OUTPUT_ENABLED: "true"
      EMIT_SERVER_TELEMETRY: "false"
      ITEM_TRANSACTION_LOGGING_ENABLED: "false"

      # ============================================
      # GAME CONFIGURATION
      # ============================================

      # Server Identity
      SERVER_NAME: ${SERVER_NAME}

      # World Settings
      LEVEL_NAME: ${LEVEL_NAME}
      LEVEL_TYPE: "DEFAULT"
      LEVEL_SEED: ${LEVEL_SEED}

      # Gameplay Settings
      GAMEMODE: "survival"
      FORCE_GAMEMODE: "true"
      DIFFICULTY: "easy"
      ALLOW_CHEATS: "false"
      ALLOW_NETHER: "true"
      SPAWN_PROTECTION: "16"

      # Player Management
      PLAYER_IDLE_TIMEOUT: "30"
      DEFAULT_PLAYER_PERMISSION_LEVEL: "member"
    healthcheck:
      test: ["CMD", "/usr/local/bin/mc-monitor", "status-bedrock", "--host", "127.0.0.1", "--port", "19132"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    post_start:
      - command: ["/bin/bash", "/init-world.sh"]
    volumes:
      - minecraft-data:/data
      - ./init-world.sh:/init-world.sh:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  minecraft-data:
